# --- Build stage ---
FROM node:18-alpine AS builder
WORKDIR /app


# Add build arguments for environment variables
ARG NEXT_PUBLIC_HTTP_URL=http://localhost:5000
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_BASIC_PLAN_PRICE_ID
ARG NEXT_PUBLIC_STANDARD_PLAN_PRICE_ID
ARG NEXT_PUBLIC_PREMIUM_PLAN_PRICE_ID

# Set them as environment variables for the build
ENV NEXT_PUBLIC_HTTP_URL=$NEXT_PUBLIC_HTTP_URL
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_BASIC_PLAN_PRICE_ID=$NEXT_PUBLIC_BASIC_PLAN_PRICE_ID
ENV NEXT_PUBLIC_STANDARD_PLAN_PRICE_ID=$NEXT_PUBLIC_STANDARD_PLAN_PRICE_ID
ENV NEXT_PUBLIC_PREMIUM_PLAN_PRICE_ID=$NEXT_PUBLIC_PREMIUM_PLAN_PRICE_ID


# Copy only package.json and lock file first
COPY package*.json ./

# Increase npm timeout
# RUN npm config set fetch-retry-maxtimeout 600000
# RUN npm config set fetch-timeout 600000

RUN npm ci


# Copy the rest of the code
COPY . .

# Tailwind gets built via your "build" script
RUN npm run build

# --- Run stage ---
FROM node:18-alpine
WORKDIR /app
ENV NODE_ENV=production

# copy Next.js standalone output and static assets
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000

# server.js is generated by Next standalone
CMD ["node", "server.js"]

